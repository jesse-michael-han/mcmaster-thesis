
\label{chap:ultraproduct-coherence}
\section{Compact non-coherent objects in $\mscr{E}(T)$}

In the previous chapter, we introduced the notions of compact, stable, and coherent objects in $\mscr{E}(T)$, and we claimed that the coherent objects were precisely the definable ones. In this section, we analyze the compact non-coherent objects. As we saw in \ref{rem-coequalizer}, the prototypical example in a coherent topos of a compact non-coherent object is the coequalizer of a definable relation $R \rightrightarrows X$ on a definable set $X$ with a properly ind-definable transitive closure. Our aim in this section is to prove the lemma \ref{lemma-compact-non-coherent-objects}, which says that this obstruction to coherence actually characterizes the compact non-coherent objects in a coherent topos.

An important basic category-theoretic fact is the canonical coproduct-coequalizer decomposition of colimits (whose proof can be found, for example, in \cite{maclane-cwm}):

\fact{
  Let $\mc{D}$ be a subcategory of $\mbf{C}$ a category with all colimits.

  Then the colimit $\colim(\mc{D})$ of $\mc{D}$ is isomorphic to the coequalizer of the following diagram:

  $$
\left(\bigsqcup_{f \in \mc{D}_1} s(f) \right) \overset{F}{\underset{G}{\rightrightarrows}} \left( \bigsqcup_{d \in \mc{D}_0} d \right)
$$
where on each component $s(f) \in \mc{D}_0$ of the left hand side, $F$ sends $s(f)$ to itself $d = s(f)$ by the identity map of $d = s(f)$, and on each $s(f) \in \mc{D}_0$ of the left hand side, $G$ sends $s(f)$ to $t(f)$ by the map $f$.
  }

We apply this fact to show the following:

\lemma{
An object $B$ of a coherent topos $\mscr{E}(T)$ is compact if and only if every covering of $B$ whose domains are representables admits a finite subcover.
}

\begin{proof}
  The implication ``$\Rightarrow$'' is immediate.

  Conversely, suppose that $\{B_i \to B\}$ is a covering of $B$. By the Kan extension colimit formula and the coproduct-coequalizer decomposition of colimits, each $B_i$ is covered by (possibly infinitely many) representables. The collection of all these representables across all $B_i$ form a covering of representables of $B$. By assumption, this covering admits a finite subcovering. Therefore, only finitely many of these $B_i$ were needed since all these representable coverings factored through some $B_i$.\end{proof}

We recount the following fact from \cite{johnstone-topos-theory}, closely related to the lemma \ref{lemma-compact-non-coherent-objects}:
\fact{\label{lemma-compact-quotients-of-coherent-objects-are-coherent} (Lemma 7.36 of \cite{johnstone-topos-theory}).
  Let $\mscr{E}$ be a topos generated by compact objects. Let $X$ be a coherent object of $E$, and let $R \rightrightarrows X$ be an equivalence relation with coequalizer $R \rightrightarrows X \twoheadrightarrow X$.

  Then $Y$ is coherent if and only if $R$ is compact.
}

Our next lemma \ref{lemma-compact-non-coherent-objects} is a sharpening of the fact \ref{lemma-compact-quotients-of-coherent-objects-are-coherent}: not only will we show that a compact non-coherent object is the quotient of a coherent object by a non-compact congruence, but we will explicitly describe the non-compact congruence as an infinite join of coherent objects.

\lemma{\label{lemma-compact-non-coherent-objects}
Let $B \in \mscr{E}(T)$ be a compact non-coherent object. Then $B$ is the quotient of a coherent object $A$ by a non-compact equivalence relation $E$ which is a join of infinitely many coherent equivalence relations on $A$.
}
\begin{proof}
  Write $B$ as a colimit of a diagram $\mc{D}$ whose objects are representables $A_i$. By the coproduct-coequalizer decomposition, $B$ is a quotient of the coproduct $\bigsqcup_{A \in \mc{D_0}} A$ and therefore the maps $A_i \hookrightarrow \bigsqcup_{A \in \mc{D_0}} A \overset{p_B}{\to} B$ are a covering family for $B$. Since $B$ is compact, finitely many $A_i$, say $A_1, \dots, A_n$ suffice to cover $B$.

  What we have said so far amounts to saying that $B$ is a quotient of the coherent object $\bigsqcup_{i \leq n} A_i$, since the obvious map
  $$
\left(\bigsqcup_{i \leq n} A_i\right) \overset{i}{\hookrightarrow} \left(\bigsqcup_{A \in \mc{D}_0} A \right) \overset{p_B}{\to} B
$$
covers $B$.

It now remains to calculate the kernel relation $K'$ of $p_B \circ i$ and show that it is an infinite union of coherent relations on $\bigsqcup_{i \leq n} A_i$.

We break the remainder of the proof into the following steps:
\begin{enumerate}
\item The kernel relation $K'$ of $p_B \circ i$ is the pullback of the kernel relation $K$ of $p_B$ along the inclusion $$i \times i : \left(\bigsqcup_{i \leq n} A_i\right) \times \left(\bigsqcup_{i \leq n} A_i\right) \hookrightarrow \left(\bigsqcup_{A \in \mc{D}_0} A\right) \times \left(\bigsqcup_{A \in \mc{D}_0} A\right)$$ and therefore in every model consists of those pairs $(a_1, a_2) \in K$ such that both $a_1$ and $a_2$ are in $\bigsqcup_{i \leq n} A_i$.
  
\item Fix an arbitrary model. There is no harm in working with points and sets in a generic model since by Deligne's completeness theorem we can then lift our calculations to the classifying topos.

  Now, $K$ is by definition the smallest equivalence relation containing ``$\exists b : F(b) = a_1$ and $G(b) = a_2 \implies a_1 \sim_K a_2$.'' By how $F$ and $G$ are constructed, this means that $a \sim_K a'$ if and only if there are finitely many other points $a_1, \dots, a_n$ and maps linking $a$ to $a_1$, each $a_i$ to $a_{i+1}$, and $a_n$ to $a'$, where the maps may point in either direction.

  It follows that $K'$ is finer than just the kernel relation of the coequalizer of the pullback of $F, G : \bigsqcup_{A \in \mc{D}_0} A \to \bigsqcup_{A \in \mc{D}_0} A$ along the inclusion $i$, and is given by the following union:
  $$
K' = \bigvee_{n \in \omega} R_n
$$
where $R_0$ is the diagonal copy of $\bigsqcup_{i \leq n} A_i$, $R_1$ consists of those pairs $(a_1, a_2)$ such that there is some $a_0'$ in $\bigsqcup_{A \in \mc{D}_0} A$ such that there is a map $f$ in $\mc{D}_1$ that moves $a_1$ to $a'_0$ or vice-versa, and there is a map $g$ in $\mc{D}_1$ that moves $a'_0$ to $a_2$ or vice-versa, etc.
  
\item $R_1$ is the infinite union $\bigvee_{A \in \mc{D}_0} S_A$, where each $S_{A_k}$ corresponds to the $A$ containing a particular witness $a_k = a'_0$ as above.

\item Each $S_{A_k}$ looks like this:
  $$
\bigvee_{(f, f', g, g')} \left\{(a_i, a_j) \in A_i \times A_j \stbar \exists a_k \in A_k \medleft(a_i, a_k) \in \Gamma(f) \lor \Gamma(f') \te{ and } (a_j, a_k) \in \Gamma(g) \lor \Gamma(g')\medright\right\},
$$
where the $4$-tuple of maps $(f, f', g, g')$ ranges over definable maps $$\Def(T)(A_i, A_k) \times \Def(T)(A_k, A_i) \times \Def(T)(A_j, A_k) \times \Def(T)(A_k, A_j)$$ and therefore each $S_{A_k}$ is $\bigvee$-coherent.

Therefore, $R_1$ is $\bigvee$-coherent.
  
\item Let us inductively assume that $R_k$ is $\bigvee$-coherent as the union $\bigvee_{i \in I} T_{i}$. Then $R_{k+1}$ is the following subset of $R_{k} \times R_1$:
  $$
R_{k+1} = \left\{(a,b) \stbar \bigvee_{(T_i, S_A) \in I \times \mc{D}_0} \exists c \suchthat (a,c) \in T_i \land (a,b) \in S_A\right\}
$$
and is therefore also $\bigvee$-coherent.
\end{enumerate}

We conclude that $K'$ is $\bigvee$-coherent.
\end{proof}
\section{The coherence criterion}
\theorem{
  \label{thm-ultraproduct-coherence}
  Let $\mscr{E}(T)$ be the classifying topos of a first-order theory.  Let $B$ be an object of $\mscr{E}(T)$. The following are equivalent:
  \begin{enumerate}
  \item \label{thm-ultraproduct-coherence-B-coherent} $B$ is coherent.
  \item \label{thm-ultraproduct-coherence-pre-ultrafunctor} $\ev_B : \Mod(T) \to \Set$ is the underlying functor of a pre-ultrafunctor $(\ev_B, \Phi)$ such that, if $B$ is canonically the colimit of representables $A_i$, then each canonical map $A_i \to B$ induces an ultratransformation of the pre-ultrafunctors $(\ev_{A_i}, \id) \to (\ev_B, \Phi)$.
    \end{enumerate}
  }

  \begin{proof}
    \begin{description}
\item[$(\ref{thm-ultraproduct-coherence-B-coherent} \implies \ref{thm-ultraproduct-coherence-pre-ultrafunctor})$] If $B$ is coherent, then it is representable and $(\ev_B, \id)$ is a pre-ultrafunctor,, and since $\mbf{y} : \Def(T) \to \mscr{E}(T)$ is full and faithful, every map $A_i \to B$ corresponds to a definable function, which induces an ultratransformation $\ev(A_i) \to \ev(B)$.

    \item[($\ref{thm-ultraproduct-coherence-pre-ultrafunctor} \implies \ref{thm-ultraproduct-coherence-B-coherent}$)] First, we note that under the assumptions, $\ev_B$'s transition isomorphism is uniquely determined by the transition isomorphisms of the representables appearing in the Kan extension colimit formula for $B$: all diagrams of the form
      $$
      \begin{tikzcd}[ampersand replacement=\&]
\&    \ev_B \left(\prod_{i \to \mc{U}} M_i \right) \arrow{rr}{\Phi^B_{(M_i)}} \& \& \prod_{i \to \mc{U}} \ev_B(M_i) \\
        \ev_A\left(\prod_{i \to \mc{U}} M_i \right) \arrow[swap]{rr}{\hspace{13mm} \Phi^A_{(M_i)}} \arrow{ur} \arrow{dr}  \& \& \prod_{i \to \mc{U}} \ev_A(M_i) \arrow{ur} \arrow{dr} \& \\
        \& \ev_{A'} \arrow[swap]{rr}{\Phi^{A'}_{(M_i)}} \arrow{uu} \& \& \prod_{i \to \mc{U}} \ev_{A'} (M_i) \arrow{uu}
        \end{tikzcd}
      $$
      commute, and since the Kan extension colimit formula is computed pointwise, the transition isomorphism $\Phi^B_{(M_i)}$ is a unique comparison map from the colimit $\ev_B \left(\prod_{i \to \mc{U}} M_i \right)$ of the $\ev_A(\prod_{i \to \mc{U}} M_i)$'s into $\prod_{i \to \mc{U}} \ev_B(M_i)$.

      Now, knowing this, suppose $B$ is not coherent. Then either $B$ cannot be covered by finitely many definables, or it can. If it can be covered by the finitely many definables $A_1, \dots, A_n$, then the associated map $A_1 \sqcup \dots \sqcup A_n \twoheadrightarrow B$ does not have a definable kernel relation, and in fact by \ref{lemma-compact-non-coherent-objects}, the kernel relation is properly ind-definable.

      In either case, we know what the transition isomorphism $\Phi^B_{(M_i)}$ looks like. In the first case, if $B$ cannot be covered by finitely many definables, we still know from the Kan extension colimit formula that it can be covered by infinitely many $(A_i)_{i \in I}$. Fix a model $M$ and take a sequence $(a_i)_{i \in I}$ such that for every $A_j$, cofinitely many $a_i$ are not in (the image of) $A_j$ (in $B$). Then for a non-principal ultrafilter $\mc{U}$ on $I$, $[a_i]_{i \in \mc{U}}$ is not in any of the (images of the) $(M^{\mc{U}})(A_j)$'s. Therefore, it is not in the image of the transition isomorphism $\Phi^B_{(M)}$, a contradiction.

      In the second case, if $B$ looks like a definable set $A$ quotiented by a properly ind-definable equivalence relation $R = \bigcup_{i \in I} R_i$, then once again we know that the transition isomorphism
      $$
\left(\prod_{i \to \mc{U}}M_i\right) \left(A/R\right) \to \prod_{i \to \mc{U}}(M_i(A/R))
$$
is the ``obvious'' one. Here's what the ``obvious'' map is: since $A$ is definable, we are really comparing two equivalence relations on the same set. On the left hand side, we have that $[a_i]_{i \to \mc{U}} \sim [b_i]_{i \to \mc{U}}$ if and only if there exists some $R_j$ such that $(\prod_{i \to \mc{U}}M_i)(R_j)$ contains $([a_i], [b_i])_{i \to \mc{U}}$. On the right hand side, we have that $[a_i]_{i \to \mc{U}} \sim [b_i]_{i \to \mc{U}}$ if and only if $a_i \sim_R b_i$ $\mc{U}$-often. Since $R$ is properly ind-definable, the equivalence relation on the left is properly contained in the equivalence relation on the right. This containment induces a map between the quotients, and since the containment is proper, this map is not injective, and cannot be a bijection.
      \end{description}

    \end{proof}
  
  Now we use this result to prove a stronger statement than \ref{thm-main-theorem}. The difference is that in the original statement of \ref{thm-main-theorem}, we only concluded that $X$ was definable, without saying anything about the transition isomorphism $\Phi$ which allowed us to view $(X, \Phi)$ as a $\Delta$-functor. In fact, we can show that $(X,\Phi)$ is isomorphic to $\ev_{\varphi(x)}$, and must therefore be an ultrafunctor.


  
\theorem{\label{thm-other-main-theorem}
    Let $T$ be $\aleph_0$-categorical. Let $(X, \Phi)$ be a pre-ultrafunctor. Then the underlying functor $X$ is definable if and only if for some $\varphi(x) \in T$, $(X, \Phi)$ is isomorphic as a pre-ultrafunctor to $\ev_{\varphi(x)}$ (equivalently, by strong conceptual completeness \ref{thm-scc}, $(X, \Phi)$ is an ultrafunctor).
  }
  
\begin{proof}
  By applying the lemma \ref{lemma-delta-functors-preserve-filtered-colimits} that $\Delta$-functors preserve filtered colimits and arguing as in the first part of the proof of \ref{thm-main-theorem}, we conclude that $X$ is isomorphic to a possibly infinite disjoint union of representables $\bigsqcup_{i \in I} A_i$. In this way, $X$ is canonically the colimit of the representables $A_i$. It remains to verify the rest of item \ref{thm-ultraproduct-coherence-pre-ultrafunctor}, i.e. the canonical inclusions $A_k \hookrightarrow \bigsqcup_{i \in I} A_i \simeq X$ induce ultratransformations.

  Before proceeding, we reduce the problem of verifying this for all ultraproducts to just verifying this for all ultrapowers. This is because, in general, every ultraproduct is a filtered colimit of ultraproducts of countable models: for every $[x_i]_{i \to \mc{U}}$ in some ultraproduct $\prod_{i \to \mc{U}} N_i$, take a countable elementary model $M_i \overset{f_i}{\hookrightarrow} N_i$ which contains $x_i$; then there is an embedding $\prod_{i \to \mc{U}} f_i : \prod_{i \to \mc{U}} M_i \hookrightarrow \prod_{i \to \mc{U}} N_i$, and the collection of all such embeddings covers $\prod_{i \to \mc{U}} N_i$. Since $T$ is $\aleph_0$-categorical, an ultraproduct of countable models is just an ultrapower of the unique countable model.

  So, it remains to check that the diagram
  $$
  \begin{tikzcd}[ampersand replacement = \&]
X\left(M^{\mc{U}} \right) \arrow{rr}{\Phi_{(M)}}    \& \& X(M)^{\mc{U}}\\
    \& \arrow{ul}{\iota_{M^{\mc{U}}}} \arrow[swap]{ur}{\prod_{i \to \mc{U}} \iota_i}  A\left(M^{\mc{U}} \right) \&
    \end{tikzcd}
  $$
  commutes. Each component $\iota_N$ of the ultratransformation is determined by filtered colimits of the countable model $M$, with $\iota_M$ determined by sending the support $a_x \in A(M)$ to $x$. Since $\Delta_M : M \to M^{\mc{U}}$ is part of the filtered diagram of countable submodels of $M^{\mc{U}}$, $\iota_{M^{\mc{U}}}$ of $\Delta_M(a_x) = X(\Delta_M)(x)$, and since $(X, \Phi)$ was a $\Delta$-functor, $\Phi_{(M)} \circ X(\Delta_M)(x) = \Delta_{X(M)}(x)$.

  On the other hand, $$\prod_{i \to \mc{U}} \iota_i \left(\Delta(a_x)\right) = [\iota_M(a_x)]_{i \to \mc{U}} = \Delta_{X(M)}(x).$$ So the diagram commutes, and now we are done by the direction $\ref{thm-ultraproduct-coherence-pre-ultrafunctor} \implies \ref{thm-ultraproduct-coherence-B-coherent}$ of the theorem.
\end{proof}

